<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Lindy Hop & Boogie Woogie Figures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Include Papa Parse via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* Universal Box Sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    /* Dark Mode Styling */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #121212;
      color: #e0e0e0;
    }
    header {
      background-color: #222;
      color: #fff;
      padding: 10px;
      text-align: center;
    }
    .filter-controls {
      background: #333;
      padding: 10px;
      color: #fff;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .filter-group {
      margin: 5px 10px;
    }
    .filter-group span {
      margin-right: 5px;
      font-weight: bold;
    }
    .filter-group label {
      margin-right: 8px;
      cursor: pointer;
    }
    /* Accordion container: center and limit width */
    .accordion {
      max-width: 600px;
      width: 100%;
      margin: 20px auto;
      padding: 0 10px;
    }
    .accordion-item {
      width: 100%;
      background: #1e1e1e;
      border-radius: 4px;
      margin-bottom: 10px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .accordion-header {
      padding: 10px;
      cursor: pointer;
      background: #2a2a2a;
      user-select: none;
      color: #fff;
    }
    .accordion-content {
      display: none;
      padding: 10px;
      border-top: 1px solid #444;
      background: #1e1e1e;
    }
    .accordion-item.active .accordion-content {
      display: block;
    }
    video {
      width: 100%;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    @media (max-width: 600px) {
      .accordion {
        margin: 20px 10px;
        padding: 0 5px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Lindy Hop & Boogie Woogie Figures</h1>
  </header>
  
  <!-- Filter Controls -->
  <div class="filter-controls">
    <!-- Tempi Filter -->
    <div class="filter-group" id="tempiFilterGroup">
      <span>Tempi:</span>
      <label><input type="checkbox" value="2">2</label>
      <label><input type="checkbox" value="4">4</label>
      <label><input type="checkbox" value="6">6</label>
      <label><input type="checkbox" value="8">8</label>
      <label><input type="checkbox" value="10">10</label>
      <label><input type="checkbox" value="12">12</label>
      <label><input type="checkbox" value="16">16</label>
    </div>
    <!-- Stile Filter -->
    <div class="filter-group" id="stileFilterGroup">
      <span>Stile:</span>
      <label><input type="checkbox" value="non specificato">Non specificato</label>
      <label><input type="checkbox" value="aperta">Aperta</label>
      <label><input type="checkbox" value="passo base">Passo Base</label>
      <label><input type="checkbox" value="caramelle">Caramelle</label>
      <label><input type="checkbox" value="finisher">Finisher</label>
    </div>
    <!-- Presa Filter -->
    <div class="filter-group" id="presaFilterGroup">
      <span>Presa:</span>
      <label><input type="checkbox" value="non specificato">Non specificato</label>
      <label><input type="checkbox" value="standard">Standard</label>
      <label><input type="checkbox" value="separati">Separati</label>
      <label><input type="checkbox" value="doppia">Doppia</label>
      <label><input type="checkbox" value="incrociata">Incrociata</label>
      <label><input type="checkbox" value="chiusa">Chiusa</label>
      <label><input type="checkbox" value="tandem">Tandem</label>
      <label><input type="checkbox" value="aperta">Aperta</label>
    </div>
    <!-- Video Filter -->
    <div class="filter-group" id="videoFilterGroup">
      <span>Video:</span>
      <label><input type="radio" name="videoFilter" value="all" checked> Tutti</label>
      <label><input type="radio" name="videoFilter" value="with">Con Video</label>
      <label><input type="radio" name="videoFilter" value="without">Senza Video</label>
    </div>
  </div>
  
  <!-- Accordion container -->
  <main>
    <div class="accordion" id="accordionContainer">
      <!-- Accordion items will be generated here -->
    </div>
  </main>
  
  <script>
    let figures = []; // Array to hold CSV data
    let currentActiveItem = null; // To track the open accordion item

    // Function to display the accordion items in CSV order
    function displayAccordion(figureList) {
      const container = document.getElementById('accordionContainer');
      container.innerHTML = ''; // Clear previous content

      if (figureList.length === 0) {
        container.innerHTML = '<p>Nessuna figura corrisponde ai filtri selezionati.</p>';
        return;
      }

      figureList.forEach(figure => {
        const item = document.createElement('div');
        item.className = 'accordion-item';

        // Accordion header (always visible)
        const header = document.createElement('div');
        header.className = 'accordion-header';
        header.textContent = figure.Figura;
        header.addEventListener('click', () => {
          // If another item is open, close it and pause its video.
          if (currentActiveItem && currentActiveItem !== item) {
            const oldVideo = currentActiveItem.querySelector('video');
            if (oldVideo) oldVideo.pause();
            currentActiveItem.classList.remove('active');
          }
          // Toggle the clicked item.
          const isExpanding = !item.classList.contains('active');
          item.classList.toggle('active');
          currentActiveItem = item.classList.contains('active') ? item : null;

          // Play or pause the video based on the new state.
          const videoEl = item.querySelector('video');
          if (videoEl) {
            if (isExpanding) {
              videoEl.play();
            } else {
              videoEl.pause();
            }
          }
        });
        item.appendChild(header);

        // Accordion content (hidden by default)
        const content = document.createElement('div');
        content.className = 'accordion-content';
        // For display, treat empty Stile and Presa as "Non specificato"
        const displayStile = figure.Stile === "" ? "Non specificato" : figure.Stile;
        const displayPresa = figure.Presa === "" ? "Non specificato" : figure.Presa;
        content.innerHTML = `
          ${ figure.Video !== "" ? `<video src="video/${figure.Video}.mp4" loop muted playsinline></video>` 
                                   : '<p><em>Nessun video disponibile.</em></p>' }
          <p><strong>Tempi:</strong> ${figure.Tempi}</p>
          <p><strong>Stile:</strong> ${displayStile}</p>
          <p><strong>Presa:</strong> ${displayPresa}</p>
        `;
        item.appendChild(content);
        container.appendChild(item);
      });
    }

    // Helper to get selected values from a filter group
    function getSelectedValues(groupId) {
      const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]`);
      return Array.from(checkboxes)
                  .filter(cb => cb.checked)
                  .map(cb => cb.value);
    }

    // Filter the figures based on selected options
    function filterFigures() {
      const selectedTempi = getSelectedValues('tempiFilterGroup');
      const selectedStile = getSelectedValues('stileFilterGroup');
      const selectedPresa = getSelectedValues('presaFilterGroup');
      const videoFilter = document.querySelector('input[name="videoFilter"]:checked').value;

      const filteredFigures = figures.filter(figure => {
        // Check Tempi: if no filter is selected, accept all; otherwise, must match.
        const tempiMatch = selectedTempi.length === 0 || selectedTempi.includes(figure.Tempi);
        
        // For Stile: treat empty as "non specificato"
        let stileValue = figure.Stile === "" ? "non specificato" : figure.Stile;
        const stileMatch = selectedStile.length === 0 || selectedStile.includes(stileValue);
        
        // For Presa: treat empty as "non specificato"
        let presaValue = figure.Presa === "" ? "non specificato" : figure.Presa;
        const presaMatch = selectedPresa.length === 0 || selectedPresa.includes(presaValue);
        
        // Video filter: check whether a video is available (non-empty) or not.
        const videoPresent = figure.Video !== "";
        const videoMatch = videoFilter === "all" ||
                           (videoFilter === "with" ? videoPresent : !videoPresent);

        return tempiMatch && stileMatch && presaMatch && videoMatch;
      });

      displayAccordion(filteredFigures);
    }

    // Add event listeners to all filter inputs.
    document.querySelectorAll('.filter-controls input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', filterFigures);
    });
    document.querySelectorAll('.filter-controls input[name="videoFilter"]').forEach(rb => {
      rb.addEventListener('change', filterFigures);
    });

    // Fetch and parse the CSV file
    fetch('lista_figure.csv')
      .then(response => response.text())
      .then(csvText => {
        const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        figures = results.data;
        // Normalize and trim the fields.
        figures.forEach(item => {
          item.Tempi = item.Tempi ? item.Tempi.trim() : "";
          item.Stile = item.Stile ? item.Stile.trim().toLowerCase() : "";
          item.Presa = item.Presa ? item.Presa.trim().toLowerCase() : "";
          item.Video = item.Video ? item.Video.trim() : "";
        });
        displayAccordion(figures);
      })
      .catch(error => console.error("Errore nel caricamento del CSV:", error));
  </script>
</body>
</html>
